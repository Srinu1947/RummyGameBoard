<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<!-- Scripts and CSS -->
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.css" />
		<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
		<script src="https://code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/0.8.1/mustache.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/json2/20130526/json2.min.js"></script>
	</head>
	<body>
		<div id='headerHolder'></div>
		<div id="mainContent"></div>
		<!-- Application templates -->
		<!-- Landing/Main template, renders after a refresh -->
		<script id="mainTemplate" type="text/template">
			<input type="text" placeholder="Enter Team Name" id="teamName">
			<input type="number" placeholder="Enter Game Total Score" id="gameTotalScore">
			<input type="number" placeholder="Enter Fold Score" id="foldScore">
		    <button id="renderUserManagement" class="ui-btn ui-btn-b ui-shadow ui-corner-all ui-btn-icon-right ui-icon-arrow-r">Continue</button>
		</script>
		<!-- Teamplate for rendering Header in different views -->
		<script type="text/template" id="headerContent">
			<div data-role="header" data-theme='b' id='headerDiv'>
				<button class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-home ui-btn-icon-notext ui-btn-b" id="homeButton">Home</button>
				<h1>{{message}}</h1>
				{{#needAddUser}}
				<button class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-user ui-btn-icon-notext ui-btn-b" id="addUserBtn">
				{{/needAddUser}}
			</div>
		</script>
		<!-- Teamplate for adding the users in the team -->
		<script type="text/template" id='addUserTemplate'>
			<div id='addUserTableDiv'>
				<table>
					<tr>
					<td><input type="text" class="ui-mini" id="userNameEle" placeholder="Enter User Name"></td>
					<td>
						<button class="ui-btn ui-shadow ui-corner-all ui-icon-check ui-btn-icon-notext ui-btn-b ui-btn-inline" id="addIndividualUser"></button>
					</td>
					<td>
						<button class="ui-btn ui-shadow ui-corner-all ui-icon-minus ui-btn-icon-notext ui-btn-b ui-btn-inline" id="removeIndividualUser"></button>
					</td>
					<tr>
				</table>
			</div>
		</script>

		<!-- Template for Game Board -->
		<script type="text/template" id="gameTemplate">
			<table>
			{{#players}}
				<tr>
					<td> <button class="ui-btn ui-mini ui-shadow ui-corner-all ui-btn-icon-left ui-icon-user" id='userNameBtn'>{{name}}</button> </td>
					<td> <input type="number" placeholder="Enter Score" id='playerScoreText'> </td>
					<td> <button class="ui-btn ui-shadow ui-corner-all ui-btn-icon-right ui-icon-plus ui-btn-icon-notext ui-btn-b" id="addScoreBtn"> </td>
					<td> <button class="ui-btn ui-btn-b ui-corner-all ui-mini" id='foldBtn'>Fold</button> </td>
					<td> <button class="ui-btn ui-mini ui-shadow ui-corner-all ui-btn-icon-left ui-icon-star" id='scoreBtn'>{{score}}</button></td>
				</tr>
			{{/players}}
			</table>
		</script>

		<script type="text/javascript">
			$(document).ready(function(){
				/* Application Data */
				var teamInfo = new Object();
				teamInfo.teamMembers = [];

				/* Instance that holds each player details */
				function Player(name){
					this.name = name;
					this.score = 0;
					this.numFolds = 0;
					this.scores = [];
					this.addScore = function(score){
						this.scores.push(score);
						this.score += parseInt(score);
						return this.score;
					};
					this.getPlayerName = function(){
						return this.name;
					},
					this.addFoldScore = function(score){
						this.numFolds++;
						return this.addScore(score);
					};
				}

				/* Utility functions for the entire application */
				var appUtilities = new Object();
				appUtilities.appendHeader = function(message, needAddUser){
					return Mustache.render($('#headerContent').html(), {message: message, needAddUser: needAddUser});
				};
				appUtilities.deletePlayer = function(givenName){
					teamInfo.teamMembers = _.filter(teamInfo.teamMembers, function(member){
						return member.name === givenName;
					});
				};
				appUtilities.printPlayersInfo = function(){
					_.each(teamInfo.teamMembers, function(member){
						console.log(member);
					});
				};
				appUtilities.getPlayerInfoByName = function(name){
					return _.find(teamInfo.teamMembers, function(player){
						return player.name === name;
					});
				}

				/* Router for the application */
				var GameRouter = Backbone.Router.extend({
					initialize: function(){
						this.mainContentView = new MainContentView();
						this.userMangementView = new UserMangementView();
						this.gameBoardView = new GameBoardView();
					},
					routes: {
						'': 'mainContentCall',
						'userManagementCall': 'userManagementCall',
						'gameBoardViewCall': 'gameBoardViewCall'
					},
					mainContentCall: function(){
						this.mainContentView.render();		
					},
					userManagementCall: function(){
						this.userMangementView.render();
					},
					gameBoardViewCall: function(){
						this.gameBoardView.render();
					}
				});

				/* View for Game Board */
				var GameBoardView = Backbone.View.extend({
					initialize: function(){

					},
					el: '#mainContent',
					events: {
						// 'click #userNameBtn': false,
						// 'click #scoreBtn': false,
						'click #addScoreBtn' : 'addScoreBtnClick',
						'click #foldBtn': 'foldBtnClick'
					},
					render: function(){
						this.$el.empty();
						var jsonObj = new Object();
						jsonObj.players = teamInfo.teamMembers;
						var json2 = JSON.stringify(jsonObj);
						var json = $.parseJSON(json2);
						console.log(json);
						this.$el.append(appUtilities.appendHeader("Game "+teamInfo.teamName, false)).trigger('create');
						var template = $('#gameTemplate').html();
						var view = Mustache.render(template, json);
						this.$el.append(view).trigger('create');
					},
					addScoreBtnClick: function(event){
						var table = $(event.target).closest('tr'),
						playerScoreBtn = table.find('#playerScoreText'),
						playerName = table.find('#userNameBtn').text();
						var updatedScore = this.addScoreToPlayer(playerName, playerScoreBtn.val(), false);
						
						/* Updating the details */
						playerScoreBtn.val('');
						table.find('#scoreBtn').text(updatedScore);
						appUtilities.printPlayersInfo();

					},
					foldBtnClick: function(event){
						console.log(' in foldBtnClick');
					},
					addScoreToPlayer: function(name, score, isFold){
						if(name === '' || score === '')
							return '0';
						var player = appUtilities.getPlayerInfoByName(name);
						if(isFold)
							player.addFoldScore(score);
						else
							player.addScore(score);
						return player.score;
					}
				});

				/* View for Inserting the users */
				var UserMangementView = Backbone.View.extend({
					el:'#mainContent',
					events: {
						'click #startGameBtn': 'navigateToStartGame',
						'click #addIndividualUser': 'addIndividualUser',
						'click #removeIndividualUser': 'removeIndividualUser',
						'click #addUserBtn': 'addUserBtn',
						'click #homeButton': 'navigateHome'
					},
					initialize: function(){
					},
					addUserBtn: function(event){
						$(this.$el.find('#addUserTableDiv')).prepend(this.getAddUserTemplate()).trigger('create');
					},
					removeIndividualUser: function(event){
						var tableEle = $(event.target).closest('table');
							playerNameTextEle = $(tableEle).find('#userNameEle'),
							playerName = playerNameTextEle.val();
						appUtilities.deletePlayer(playerName);
						$(tableEle).remove();
					},
					addIndividualUser: function(event){
						var playerNameTextEle = $(event.target).closest('tr').find('#userNameEle');
						var playerName = playerNameTextEle.val();
						teamInfo.teamMembers.push(new Player(playerName));
						$(playerNameTextEle).addClass('ui-state-disabled');
						$(event.target).addClass('ui-state-disabled');
					},
					navigateToStartGame: function(){
						router.navigate('gameBoardViewCall', {trigger:true});
					},
					navigateHome: function(){
						router.navigate('',{trigger:true});
					},
					render: function(){
						this.$el.empty();
						var header = appUtilities.appendHeader('Add Players in '+teamInfo.teamName, true);
						this.$el.append(header).trigger('create');
						this.$el.append($('#addUserTemplate').html()).trigger('create');
						this.$el.append('<button id="startGameBtn" class="ui-btn ui-btn-b ui-shadow ui-corner-all">Start Game</button>');
					},
					getAddUserTemplate: function(){
						return $($('#addUserTemplate').html()).find('table');
					}
				});

				/* Main view for the application */
				var MainContentView = Backbone.View.extend({
					el:'#mainContent',
					events: {
						'click #renderUserManagement':'navigateToUserManagement'
					},
					initialize: function(){
					},
					render: function(){
						this.$el.empty();
						var header = appUtilities.appendHeader("Welcome to Game Board", false);
						var template = $('#mainTemplate').html();
						this.$el.append(header).trigger('create');
						this.$el.append(template).trigger('create');
					},
					navigateToUserManagement: function(){
						teamInfo.teamName = $('#teamName').val();
						teamInfo.totalScore = $('#gameTotalScore').val();
						teamInfo.foldScore = $('#foldScore').val();
						router.navigate('userManagementCall', {trigger: true});
					}
				});

				/* Initantiate the Router here, this starts the application*/
				var router = new GameRouter();
				Backbone.history.start();
			});
		</script>
	</body>
</html>