<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<!-- Scripts and CSS -->
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.css" />
		<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
		<script src="https://code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/0.8.1/mustache.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/json2/20130526/json2.min.js"></script>
	</head>
	<body>
		<div id='headerHolder'></div>
		<div id="mainContent"></div>

		<script type="text/template" id="headerContent">
			<div data-role="header" data-theme='b'>
				<button class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-home ui-btn-icon-notext ui-btn-b" id="homeButton">Home</button>
				<h1>{{message}}</h1>
				{{#needAddUser}}
				<button class="ui-btn ui-shadow ui-corner-all ui-btn-icon-right ui-icon-user ui-btn-icon-notext ui-btn-b" id="addUserBtn">
				{{/needAddUser}}
			</div>
		</script> 

		<script id="mainTemplate" type="text/template">
			<input type="text" placeholder="Enter Team Name" id="teamName">
			<input type="number" data-clear-btn="true" placeholder="Enter Game Total Score" id="gameTotalScore">
			<input type="number" data-clear-btn="true" placeholder="Enter Fold Score" id="foldScore">
		    <button id="renderNameView" class="ui-btn ui-btn-b ui-shadow ui-corner-all ui-btn-icon-right ui-icon-arrow-r">Continue</button>
		</script>
		
		<script type="text/template" id="gameTemplate">
			<table>
			{{#players}}
				<tr>
					<td> <button class="ui-btn ui-mini ui-shadow ui-corner-all ui-btn-icon-left ui-icon-user ui-state-disabled">{{name.name}}</button> </td>
					<td> <input type="number" data-clear-btn="true" placeholder="Enter Score"> </td>
					<td> <button class="ui-btn ui-shadow ui-corner-all ui-btn-icon-right ui-icon-plus ui-btn-icon-notext ui-btn-b" id="addUserBtn"> </td>
					<td> <button class="ui-btn ui-btn-b ui-corner-all ui-mini">Fold</button> </td>
					<td> <button class="ui-btn ui-mini ui-shadow ui-corner-all ui-btn-icon-left ui-icon-star ui-state-disabled">{{score}}</button></td>
				</tr>
			{{/players}}
			</table>
		</script>

		<script type="text/template" id='addUserTemplate'>
			<table>
				<tr>
				<td><input type="text" class="ui-mini" id="userNameEle" placeholder="Enter User Name"></td>
				<td>
					<button class="ui-btn ui-shadow ui-corner-all ui-icon-check ui-btn-icon-notext ui-btn-b ui-btn-inline" id="addIndividualUser"></button>
				</td>
				<td>
					<button class="ui-btn ui-shadow ui-corner-all ui-icon-minus ui-btn-icon-notext ui-btn-b ui-btn-inline" id="removeIndividualUser"></button>
				</td>
				<tr>
			</table>
		</script>

		<script type="text/template" id="startGameBtnTemplate">
			<button id="startGameView" class="ui-btn ui-btn-b ui-shadow ui-corner-all ui-btn-icon-right ui-icon-arrow-r">Start Game
			</button>
		</script>

		<script type="text/javascript">
			$(document).ready(function(){
				var SampleObj = Backbone.View.extend({
					initialize: function(){
						this.teamName;
						this.teamMembers = [];
						this.renderLandingTemplate();
					},
					el:'#mainContent',
					events: {
						'click #renderNameView': 'handleRenderNameView',
						'click #addIndividualUser': 'addIndividualUser',
						'click #removeIndividualUser': 'removeIndividualUser',
						'click #startGameView': 'startGameView'
					},
					startGameView: function(){ 
						if(this.teamMembers.length){
							var jsonObj = new Object();
							jsonObj.players = this.teamMembers;
							var json2 = JSON.stringify(jsonObj);
							var json = $.parseJSON(json2);
							this.appendHeader("Game "+this.teamName, false);
							var template = $('#gameTemplate').html();
							var view = Mustache.render(template, json);
							this.$el.html(view).trigger('create');
							this.addClickEventHomeBtn();
						} else {
							this.removeErrorHeaders();
							this.$el.prepend(
								'<p style="color:red"> Please enter User. Click top right User button to add</p>').trigger('create');
						}
					},
					removeIndividualUser: function(event){
						var removeBtnEle = $(event.target.parentElement.parentElement).find("#userNameEle"),
							userText = removeBtnEle.val();
						var teamMembersUpdate = $.grep(this.teamMembers, function(member){
							return member.getPlayerName().name !== userText;
						});
						this.teamMembers = teamMembersUpdate;
						$($(event.target).parents('table')).remove();
					},
					addIndividualUser: function(event){
						var textEle = $(event.target.parentElement.parentElement).find("#userNameEle"),
							userText = textEle.val();
						var player = new Player({name:userText});
						this.teamMembers.push(player);
						$(event.target).addClass('ui-state-disabled');
						$(textEle).addClass('ui-state-disabled');
					},
					handleRenderNameView: function(){
						this.teamName = $('#teamName').val();
						this.appendHeader("Who's Playing in team "+this.teamName+"?", true);
						this.addClickEventHomeBtn();
						this.addClickEventForUserBtn();
						var button = $('#startGameBtnTemplate').html();
						this.$el.html(button).trigger('create');
					},
					handleAddUserClick: function(){
						if(!this.teamMembers.length)
							this.removeErrorHeaders();
						var template = $('#addUserTemplate').html();
						this.$el.prepend(template).trigger('create');
					},
					renderLandingTemplate: function(){
						this.appendHeader("Welcome to Game Board", false);
						var template = $('#mainTemplate').html();
						this.$el.html(template).trigger('create');
					},
					addClickEventHomeBtn: function(){
						var there = this;
						$('#homeButton').click(function(){
							there.renderLandingTemplate();
						});
					},
					addClickEventForUserBtn: function(){
						var there = this;
						$('#addUserBtn').click(function(){
							there.handleAddUserClick();
						});
					},
					appendHeader: function(message, needAddUser){
						$('#headerHolder').html(Mustache.render($('#headerContent').html(), {message: message, needAddUser: needAddUser})).trigger('create');
					},
					removeErrorHeaders: function(){
						this.$el.find('p').remove();
						this.$el.find('table').remove();
					}
				});
				
				/* Game Starts here */
				new SampleObj();

				/* Instance that holds each player details */
				function Player(name){
					this.name = name;
					this.score = 0;
					this.numFolds = 0;
					this.scores = [];
					this.addScore = function(score){
						this.scores.push(score);
						this.score += score;
						return this.score;
					};
					this.getPlayerName = function(){
						return this.name;
					},
					this.addAddFoldScore = function(score){
						this.numFolds++;
						return this.addScore(score);
					};
				}
			});
		</script>
		
	</body>
</html>